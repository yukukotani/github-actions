name: Draft Release (Reusable)

on:
  workflow_call:
    inputs:
      version:
        description: 'Version type (patch, minor, or major)'
        required: true
        type: string
      node-version:
        description: 'Node.js version to use'
        required: false
        type: string
        default: 'lts/*'
      package-manager:
        description: 'Package manager to use (npm or none)'
        required: false
        type: string
        default: 'npm'
      pr-labels:
        description: 'Labels to add to the PR (JSON array format)'
        required: false
        type: string
        default: '["Type: Release"]'
      draft-pr:
        description: 'Create PR as draft'
        required: false
        type: boolean
        default: true
    outputs:
      version:
        description: 'The new version number'
        value: ${{ jobs.create-release-pr.outputs.version }}
      pr-number:
        description: 'The created PR number'
        value: ${{ jobs.create-release-pr.outputs.pr-number }}

jobs:
  create-release-pr:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    outputs:
      version: ${{ steps.version.outputs.version }}
      pr-number: ${{ steps.create-pr.outputs.pull-request-number }}
    steps:
      - name: Checkout
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
        with:
          persist-credentials: false

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Setup Node.js
        if: inputs.package-manager != 'none'
        uses: actions/setup-node@a0853c24544627f65ddf259abe73b1d18a591444 # v5.0.0
        with:
          node-version: ${{ inputs.node-version }}

      - name: Version bump
        id: version
        run: |
          if [ "$PACKAGE_MANAGER" = "npm" ]; then
            npm version "$VERSION_TYPE" --no-git-tag-version
          else
            echo "Package manager '$PACKAGE_MANAGER' is not supported for version bump"
            exit 1
          fi
          VERSION=$(jq -r '.version' package.json)
          echo "version=$VERSION" >> $GITHUB_OUTPUT
        env:
          VERSION_TYPE: ${{ inputs.version }}
          PACKAGE_MANAGER: ${{ inputs.package-manager }}

      - name: Get release notes
        id: release-notes
        run: |
          # Get the default branch
          DEFAULT_BRANCH=$(gh api "repos/$GITHUB_REPOSITORY" --jq '.default_branch')

          # Get the latest release tag using GitHub API
          # Use the exit code to determine if a release exists
          if LAST_TAG=$(gh api "repos/$GITHUB_REPOSITORY/releases/latest" --jq '.tag_name' 2>/dev/null); then
            echo "Previous release found: $LAST_TAG"
          else
            LAST_TAG=""
            echo "No previous releases found - this will be the first release"
          fi

          # Generate release notes - only include previous_tag_name if we have a valid previous tag
          echo "Generating release notes for tag: v$VERSION"
          if [ -n "$LAST_TAG" ]; then
            echo "Using previous tag: $LAST_TAG"
            RELEASE_NOTES=$(gh api \
              --method POST \
              -H "Accept: application/vnd.github+json" \
              "/repos/$GITHUB_REPOSITORY/releases/generate-notes" \
              -f "tag_name=v$VERSION" \
              -f "target_commitish=$DEFAULT_BRANCH" \
              -f "previous_tag_name=$LAST_TAG" \
              --jq '.body')
          else
            echo "Generating notes from all commits"
            RELEASE_NOTES=$(gh api \
              --method POST \
              -H "Accept: application/vnd.github+json" \
              "/repos/$GITHUB_REPOSITORY/releases/generate-notes" \
              -f "tag_name=v$VERSION" \
              -f "target_commitish=$DEFAULT_BRANCH" \
              --jq '.body')
          fi

          # Set release notes as environment variable
          echo "RELEASE_NOTES<<EOF" >> $GITHUB_ENV
          echo "$RELEASE_NOTES" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV
        env:
          GH_TOKEN: ${{ github.token }}
          VERSION: ${{ steps.version.outputs.version }}
          GITHUB_REPOSITORY: ${{ github.repository }}

      - name: Create Pull Request
        id: create-pr
        uses: peter-evans/create-pull-request@271a8d0340265f705b14b6d32b9829c1cb33d45e # v7.0.8
        with:
          branch: release/v${{ steps.version.outputs.version }}
          delete-branch: true
          title: "Release v${{ steps.version.outputs.version }}"
          body: |
            ${{ env.RELEASE_NOTES }}
          commit-message: "chore: release v${{ steps.version.outputs.version }}"
          labels: ${{ inputs.pr-labels }}
          assignees: ${{ github.actor }}
          draft: ${{ inputs.draft-pr }}
